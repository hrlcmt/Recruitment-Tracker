<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แอปติดตามการสรรหาบุคลากร</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel to transpile JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Sarabun:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        /* ใช้ฟอนต์ Sarabun สำหรับภาษาไทยและ Inter สำหรับข้อความอื่นๆ */
        body {
            font-family: 'Sarabun', 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        // --- การนำเข้า Firebase ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, updateDoc, deleteDoc, doc, writeBatch, query, getDocs, where, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        const { useState, useEffect, useMemo, useCallback, memo } = React;

        // --- คอมโพเนนต์ไอคอน (แทนที่ lucide-react) ---
        const ICONS = {
            Plus: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>,
            Users: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>,
            Briefcase: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>,
            Clock: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>,
            Target: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></svg>,
            CheckCircle: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>,
            AlertTriangle: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>,
            LayoutDashboard: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="7" height="9"></rect><rect x="14" y="3" width="7" height="5"></rect><rect x="14" y="12" width="7" height="9"></rect><rect x="3" y="16" width="7" height="5"></rect></svg>,
            Columns: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="12" y1="3" x2="12" y2="21"></line></svg>,
            HistoryIcon: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 3v5h5"></path><path d="M3.05 13A9 9 0 1 0 6 5.3L3 8"></path></svg>,
            UserPlus: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="17" y1="11" x2="23" y2="11"></line></svg>,
            ClipboardCheck: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><path d="m9 14 2 2 4-4"></path></svg>,
            Sparkles: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 3-1.9 4.2L6 9l4.2 1.9L12 15l1.9-4.2L18 9l-4.2-1.9L12 3zM21 12l-1.9 4.2L15 18l4.2 1.9L21 24l1.9-4.2L27 18l-4.2-1.9L21 12zM6 21l-1.9-4.2L0 15l4.2-1.9L6 9l1.9 4.2L12 15l-4.2 1.9L6 21z"/></svg>,
            Copy: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>,
            FileText: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>,
            Search: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>,
            Award: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="8" r="7"></circle><polyline points="8.21 13.89 7 23 12 17 17 23 15.79 13.88"></polyline></svg>,
            PartyPopper: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5.8 11.3L2 22l10.7-3.79"></path><path d="M4 14.8L11 21.8"></path><path d="M12.2 6.8L17.5 1.5"></path><path d="M14 4l.85.85"></path><path d="M18.85 8.85L15 13"></path><path d="M18 10l-3-3"></path><path d="M22 13.2L18.5 9.5"></path><path d="M17 17l-3-3"></path><path d="M13.2 22L9.5 18.5"></path></svg>,
            XCircle: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>,
            ArrowRight: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>,
            Sheet: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>,
            Edit: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>,
            Trash: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
        };
        const { Plus, Users, Briefcase, Clock, Target, CheckCircle, AlertTriangle, LayoutDashboard, Columns, HistoryIcon, UserPlus, ClipboardCheck, Sparkles, Copy, FileText, Search, Award, PartyPopper, XCircle, ArrowRight, Sheet, Edit, Trash } = ICONS;

        // --- การตั้งค่า Firebase ---
        const firebaseConfig = { 
            apiKey: "AIzaSyDEyJHyZsTPj3uiCKw5TdcvS-kL2LP7DPs",
            authDomain: "recruitment-v1-df6d1.firebaseapp.com",
            projectId: "recruitment-v1-df6d1",
            storageBucket: "recruitment-v1-df6d1.appspot.com",
            messagingSenderId: "364158250402",
            appId: "1:364158250402:web:0af46691cb2e0a698016fb",
            measurementId: "G-2136LFX8Z4"
        };
        const appId = 'recruitment-v1-df6d1';

        // --- การตั้งค่า KPI ---
        const POSITION_LEVELS = [
            'Officer', 'Operator', 'Supervisor', 'Assistant Manager', 'Manager'
        ];

        const KPI_WEEKS = {
            'Officer': 2,
            'Operator': 2,
            'Supervisor': 5,
            'Assistant Manager': 6,
            'Manager': 10,
        };

        // --- ฟังก์ชันเสริม ---
        const calculateBusinessDays = (startDateStr, endDateStr) => {
            if (!startDateStr || !endDateStr) return 0;
            let count = 0;
            const curDate = new Date(startDateStr);
            const endDate = new Date(endDateStr);
            while (curDate <= endDate) {
                const dayOfWeek = curDate.getDay();
                if (dayOfWeek !== 0 && dayOfWeek !== 6) { // 0=Sunday, 6=Saturday
                    count++;
                }
                curDate.setDate(curDate.getDate() + 1);
            }
            return count;
        };
        
        // --- คอมโพเนนต์ Modal ที่กำหนดเอง ---
        const AlertModal = ({ title, message, onClose }) => (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
                <div className="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm text-center">
                    <h3 className="text-lg font-bold text-gray-800 mb-2">{title}</h3>
                    <p className="text-gray-600 mb-6">{message}</p>
                    <button onClick={onClose} className="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600">
                        ตกลง
                    </button>
                </div>
            </div>
        );

        const ConfirmModal = ({ title, message, onConfirm, onCancel }) => (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
                <div className="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
                    <h3 className="text-lg font-bold text-gray-800 mb-2">{title}</h3>
                    <p className="text-gray-600 mb-6">{message}</p>
                    <div className="flex justify-end gap-4">
                        <button onClick={onCancel} className="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300">
                            ยกเลิก
                        </button>
                        <button onClick={onConfirm} className="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">
                            ยืนยัน
                        </button>
                    </div>
                </div>
            </div>
        );


        // --- คอมโพเนนต์หลักของแอปพลิเคชัน ---
        function App() {
            const [db, setDb] = useState(null);
            const [storage, setStorage] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);

            const [jobs, setJobs] = useState([]);
            const [candidates, setCandidates] = useState([]);
            const [loading, setLoading] = useState(true);
            const [appError, setAppError] = useState(null);
            const [currentView, setCurrentView] = useState('dashboard');
            
            const [alertInfo, setAlertInfo] = useState(null);
            const [confirmInfo, setConfirmInfo] = useState(null);

            // --- การเชื่อมต่อ Firebase และการยืนยันตัวตน ---
            useEffect(() => {
                try {
                    const app = initializeApp(firebaseConfig);
                    const firestoreDb = getFirestore(app);
                    const firebaseStorage = getStorage(app);
                    const auth = getAuth(app);
                    
                    setDb(firestoreDb);
                    setStorage(firebaseStorage);
                    
                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            setIsAuthReady(true);
                        } else {
                            signInAnonymously(auth).catch(err => {
                                console.error("Anonymous sign in failed", err);
                                setAppError("ไม่สามารถเชื่อมต่อกับบริการได้");
                            });
                        }
                    });

                } catch (e) {
                    console.error("Firebase Init Error:", e);
                    setAppError(`เกิดข้อผิดพลาดในการเชื่อมต่อ: ${e.message}`);
                    setLoading(false);
                }
            }, []);
            
            // --- การดึงข้อมูล (ตำแหน่งงานและผู้สมัคร) ---
            useEffect(() => {
                if (!isAuthReady || !db) {
                    return;
                };

                setLoading(true);
                const jobsCollectionPath = `artifacts/${appId}/public/data/jobs`;
                const candidatesCollectionPath = `artifacts/${appId}/public/data/candidates`;

                const jobsQuery = query(collection(db, jobsCollectionPath));
                const candidatesQuery = query(collection(db, candidatesCollectionPath));

                const unsubscribeJobs = onSnapshot(jobsQuery, 
                    (snapshot) => {
                        const jobsData = snapshot.docs
                            .map(doc => ({ ...doc.data(), id: doc.id }))
                            .filter(job => job.id);
                        setJobs(jobsData);
                    },
                    (err) => { console.error("Error fetching jobs:", err); setAppError("ไม่สามารถโหลดข้อมูลตำแหน่งงานได้"); }
                );

                const unsubscribeCandidates = onSnapshot(candidatesQuery, 
                    (snapshot) => {
                        const candidatesData = snapshot.docs
                            .map(doc => ({ ...doc.data(), id: doc.id }))
                            .filter(candidate => candidate.id);
                        setCandidates(candidatesData);
                        setLoading(false);
                    },
                    (err) => { console.error("Error fetching candidates:", err); setAppError("ไม่สามารถโหลดข้อมูลผู้สมัครได้"); setLoading(false); }
                );

                return () => { unsubscribeJobs(); unsubscribeCandidates(); };
            }, [isAuthReady, db]);

            // --- ฟังก์ชันจัดการข้อมูล (ห่อด้วย useCallback เพื่อประสิทธิภาพ) ---
            const handleSaveJob = useCallback(async (jobData) => {
                if (!db) return;
                const collectionPath = `artifacts/${appId}/public/data/jobs`;
                const now = new Date().toISOString();
                const user = 'nuchapol';

                if (jobData.id) {
                    const jobRef = doc(db, collectionPath, jobData.id);
                    const { id, ...dataToUpdate } = jobData;
                    await updateDoc(jobRef, { ...dataToUpdate, updated_at: now, updated_by: user });
                } else {
                    const { id, ...dataToAdd } = jobData;
                    await addDoc(collection(db, collectionPath), { ...dataToAdd, created_at: now, updated_at: now, created_by: user });
                }
            }, [db]);

            const handleSaveCandidate = useCallback(async (candidateData, photoFile) => {
                if (!db || !storage) {
                    throw new Error("Database or storage service is not available.");
                }
                
                let photo_url = `https://placehold.co/352x128/EFEFEF/AAAAAA?text=Photo`;
                
                try {
                    if (photoFile) {
                        const storageRef = ref(storage, `candidate_photos/${appId}/${Date.now()}_${photoFile.name}`);
                        await uploadBytes(storageRef, photoFile);
                        photo_url = await getDownloadURL(storageRef);
                    }

                    const collectionPath = `artifacts/${appId}/public/data/candidates`;
                    const { id, ...dataToAdd } = candidateData;
                    await addDoc(collection(db, collectionPath), {
                        ...dataToAdd,
                        photo_url,
                        stage: 'Applied',
                        status_date: new Date().toISOString(),
                        created_at: new Date().toISOString(),
                        created_by: 'nuchapol',
                        test_completed_on: null,
                    });
                } catch (error) {
                    console.error("Error during save candidate process:", error);
                    if (error.code && error.code.startsWith('storage/')) {
                        throw new Error(`เกิดข้อผิดพลาดในการอัปโหลดรูปภาพ กรุณาตรวจสอบการตั้งค่า Firebase Storage และ Security Rules`);
                    }
                    throw new Error(`เกิดข้อผิดพลาดในการบันทึกข้อมูล: ${error.message}`);
                }
            }, [db, storage]);
            
            const handleUpdateCandidate = useCallback(async (candidateData, photoFile) => {
                if (!db || !storage) {
                    throw new Error("Database or storage service is not available.");
                }
                
                let updatedData = { ...candidateData };

                try {
                    if (photoFile) {
                        const storageRef = ref(storage, `candidate_photos/${appId}/${Date.now()}_${photoFile.name}`);
                        await uploadBytes(storageRef, photoFile);
                        updatedData.photo_url = await getDownloadURL(storageRef);
                    }

                    const candidateRef = doc(db, `artifacts/${appId}/public/data/candidates`, candidateData.id);
                    const { id, ...dataToUpdate } = updatedData;
                    await updateDoc(candidateRef, dataToUpdate);

                } catch (error) {
                    console.error("Error during update candidate process:", error);
                    if (error.code && error.code.startsWith('storage/')) {
                        throw new Error(`เกิดข้อผิดพลาดในการอัปโหลดรูปภาพ กรุณาตรวจสอบการตั้งค่า Firebase Storage และ Security Rules`);
                    }
                    throw new Error(`เกิดข้อผิดพลาดในการอัปเดตข้อมูล: ${error.message}`);
                }
            }, [db, storage]);

            const handleDeleteJob = useCallback((jobId) => {
                setConfirmInfo({
                    title: "ยืนยันการลบ",
                    message: "คุณแน่ใจหรือไม่ว่าต้องการลบตำแหน่งงานนี้ และผู้สมัครทั้งหมดที่เกี่ยวข้อง? การกระทำนี้ไม่สามารถย้อนกลับได้",
                    onConfirm: async () => {
                        if (!db) return;
                        const batch = writeBatch(db);
                        const jobRef = doc(db, `artifacts/${appId}/public/data/jobs`, jobId);
                        batch.delete(jobRef);
                        
                        const candidatesCollectionPath = `artifacts/${appId}/public/data/candidates`;
                        const q = query(collection(db, candidatesCollectionPath), where("job_id", "==", jobId));
                        const querySnapshot = await getDocs(q);
                        querySnapshot.forEach((doc) => { batch.delete(doc.ref); });
                        
                        await batch.commit();
                        setConfirmInfo(null);
                    }
                });
            }, [db]);

            const handleDeleteCandidate = useCallback((candidateId) => {
                setConfirmInfo({
                    title: "ยืนยันการลบ",
                    message: "คุณแน่ใจหรือไม่ว่าต้องการลบข้อมูลผู้สมัครคนนี้? การกระทำนี้ไม่สามารถย้อนกลับได้",
                    onConfirm: async () => {
                        if (!db) return;
                        const candidateRef = doc(db, `artifacts/${appId}/public/data/candidates`, candidateId);
                        await deleteDoc(candidateRef);
                        setConfirmInfo(null);
                    }
                });
            }, [db]);

            const handleUpdateCandidateStage = useCallback(async (candidateId, newStage) => {
                if (!db) return;
                const candidateRef = doc(db, `artifacts/${appId}/public/data/candidates`, candidateId);
                await updateDoc(candidateRef, { stage: newStage, status_date: new Date().toISOString() });
            }, [db]);

            const handleMarkTestCompleted = useCallback(async (candidateId) => {
                if (!db) return;
                const candidateRef = doc(db, `artifacts/${appId}/public/data/candidates`, candidateId);
                await updateDoc(candidateRef, { test_completed_on: new Date().toISOString().split('T')[0] });
            }, [db]);

            if (!isAuthReady || loading) {
                return <div className="flex justify-center items-center h-screen"><div className="animate-spin rounded-full h-32 w-32 border-t-2 border-b-2 border-blue-500"></div></div>;
            }
            
            if (appError) return <div className="flex justify-center items-center h-screen text-red-500 p-4 bg-red-50 border border-red-200 rounded-lg">{appError}</div>;

            const renderView = () => {
                switch (currentView) {
                    case 'dashboard': return <Dashboard jobs={jobs} candidates={candidates} />;
                    case 'jobs': return <JobsList jobs={jobs} onSave={handleSaveJob} onDelete={handleDeleteJob} setAlertInfo={setAlertInfo} />;
                    case 'kanban': return <KanbanBoard jobs={jobs} candidates={candidates} onUpdateCandidateStage={handleUpdateCandidateStage} onSaveCandidate={handleSaveCandidate} onUpdateCandidate={handleUpdateCandidate} onDeleteCandidate={handleDeleteCandidate} onMarkTestCompleted={handleMarkTestCompleted} setAlertInfo={setAlertInfo} />;
                    case 'history': return <History jobs={jobs} />;
                    case 'sheets': return <GoogleSheetView setAlertInfo={setAlertInfo} />;
                    default: return <Dashboard jobs={jobs} candidates={candidates} />;
                }
            };

            return (
                <div className="bg-slate-50 min-h-screen">
                    {alertInfo && <AlertModal title={alertInfo.title} message={alertInfo.message} onClose={() => setAlertInfo(null)} />}
                    {confirmInfo && <ConfirmModal title={confirmInfo.title} message={confirmInfo.message} onConfirm={confirmInfo.onConfirm} onCancel={() => setConfirmInfo(null)} />}

                    <div className="flex flex-col md:flex-row">
                        <nav className="bg-gray-800 text-white w-full md:w-64 p-4 md:min-h-screen flex flex-col">
                            <h1 className="text-2xl font-bold mb-6 text-center">Recruitment Tracker</h1>
                            <ul className="flex-grow">
                                <li className={`p-3 rounded-lg mb-2 cursor-pointer flex items-center ${currentView === 'dashboard' ? 'bg-blue-500' : 'hover:bg-gray-700'}`} onClick={() => setCurrentView('dashboard')}><LayoutDashboard size={18} className="mr-3" />แดชบอร์ด</li>
                                <li className={`p-3 rounded-lg mb-2 cursor-pointer flex items-center ${currentView === 'jobs' ? 'bg-blue-500' : 'hover:bg-gray-700'}`} onClick={() => setCurrentView('jobs')}><Briefcase size={18} className="mr-3" />จัดการตำแหน่งงาน</li>
                                <li className={`p-3 rounded-lg mb-2 cursor-pointer flex items-center ${currentView === 'kanban' ? 'bg-blue-500' : 'hover:bg-gray-700'}`} onClick={() => setCurrentView('kanban')}><Columns size={18} className="mr-3" />กระดานคัมบัง</li>
                                <li className={`p-3 rounded-lg mb-2 cursor-pointer flex items-center ${currentView === 'history' ? 'bg-blue-500' : 'hover:bg-gray-700'}`} onClick={() => setCurrentView('history')}><HistoryIcon size={18} className="mr-3" />ประวัติ</li>
                                <li className={`p-3 rounded-lg mb-2 cursor-pointer flex items-center ${currentView === 'sheets' ? 'bg-blue-500' : 'hover:bg-gray-700'}`} onClick={() => setCurrentView('sheets')}><Sheet size={18} className="mr-3" />รายชื่อจาก Sheet</li>
                            </ul>
                            <div className="text-xs text-gray-400 mt-8 border-t border-gray-700 pt-4">
                                <p className="truncate">User: nuchapol</p>
                            </div>
                        </nav>
                        <main className="flex-1 p-4 md:p-8">
                            {renderView()}
                        </main>
                    </div>
                </div>
            );
        }

        // --- คอมโพเนนต์แดชบอร์ด ---
        const Dashboard = ({ jobs, candidates }) => {
            const [selectedJobIdForFunnel, setSelectedJobIdForFunnel] = useState('all');

            const { kpi, alerts, weeklyData, applicantTrendData } = useMemo(() => {
                const filteredCandidatesForFunnel = selectedJobIdForFunnel === 'all'
                    ? candidates
                    : candidates.filter(c => c.job_id === selectedJobIdForFunnel);

                const today = new Date();
                const dayOfWeek = today.getDay();
                const startOfWeek = new Date(today);
                startOfWeek.setDate(today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1));
                startOfWeek.setHours(0, 0, 0, 0);

                const endOfWeek = new Date(startOfWeek);
                endOfWeek.setDate(startOfWeek.getDate() + 6);
                endOfWeek.setHours(23, 59, 59, 999);

                const newApplicantsThisWeek = filteredCandidatesForFunnel.filter(c => {
                    if (!c.created_at) return false;
                    const createdAt = new Date(c.created_at);
                    return createdAt >= startOfWeek && createdAt <= endOfWeek;
                }).length;

                const testsCompletedThisWeek = filteredCandidatesForFunnel.filter(c => {
                    if (c.stage === 'ทำแบบทดสอบแล้ว' && c.status_date) {
                        const statusDate = new Date(c.status_date);
                        return statusDate >= startOfWeek && statusDate <= endOfWeek;
                    }
                    return false;
                }).length;

                const interviewedThisWeek = filteredCandidatesForFunnel.filter(c => {
                    if (c.stage !== 'Interviewed' || !c.status_date) return false;
                    const statusDate = new Date(c.status_date);
                    return statusDate >= startOfWeek && statusDate <= endOfWeek;
                }).length;

                const offeredThisWeek = filteredCandidatesForFunnel.filter(c => {
                    if (c.stage !== 'Offered' || !c.status_date) return false;
                    const statusDate = new Date(c.status_date);
                    return statusDate >= startOfWeek && statusDate <= endOfWeek;
                }).length;

                const getWeekLabel = (date) => {
                    const firstDay = new Date(date);
                    firstDay.setDate(date.getDate() - date.getDay() + 1);
                    const lastDay = new Date(firstDay);
                    lastDay.setDate(firstDay.getDate() + 6);
                    return `${firstDay.getDate()}/${firstDay.getMonth()+1} - ${lastDay.getDate()}/${lastDay.getMonth()+1}`;
                }
                
                const trendData = [];
                for (let i = 4; i >= 0; i--) {
                    const weekStart = new Date();
                    weekStart.setDate(weekStart.getDate() - weekStart.getDay() + 1 - (i * 7));
                    weekStart.setHours(0,0,0,0);
                    
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekEnd.getDate() + 6);
                    weekEnd.setHours(23,59,59,999);

                    const count = candidates.filter(c => {
                        if(!c.created_at) return false;
                        const createdAt = new Date(c.created_at);
                        return createdAt >= weekStart && createdAt <= weekEnd;
                    }).length;
                    
                    trendData.push({ name: getWeekLabel(new Date(weekStart)), 'ผู้สมัครใหม่': count });
                }

                const openJobsCount = jobs.filter(j => ['Open', 'Screening', 'Interview', 'Offer Sent'].includes(j.status)).length;
                const filledJobs = jobs.filter(j => j.status === 'Filled').length;
                const cancelledJobs = jobs.filter(j => j.status === 'Cancelled').length;
                
                const timeToFillList = jobs.filter(j => j.status === 'Filled' && j.start_date && j.close_date).map(j => calculateBusinessDays(j.start_date, j.close_date));
                const avgTimeToFill = timeToFillList.length > 0 ? (timeToFillList.reduce((a, b) => a + b, 0) / timeToFillList.length).toFixed(1) : 0;
                const successRate = (filledJobs + cancelledJobs) > 0 ? ((filledJobs / (filledJobs + cancelledJobs)) * 100).toFixed(1) : 0;

                const currentAlerts = jobs.filter(job => ['Open', 'Screening', 'Interview', 'Offer Sent'].includes(job.status)).map(job => ({ ...job, kpiStatus: getKpiStatus(job) })).filter(job => job.kpiStatus.status === 'Alert' || job.kpiStatus.status === 'Overdue');

                return { 
                    kpi: { openJobs: openJobsCount, avgTimeToFill, successRate }, 
                    alerts: currentAlerts,
                    weeklyData: { newApplicantsThisWeek, testsCompletedThisWeek, interviewedThisWeek, offeredThisWeek },
                    applicantTrendData: trendData
                };
            }, [jobs, candidates, selectedJobIdForFunnel]);

            const openJobs = useMemo(() => jobs.filter(j => !['Filled', 'Cancelled'].includes(j.status)), [jobs]);

            return (
                <div className="space-y-8">
                    <h2 className="text-3xl font-bold text-gray-800">แดชบอร์ดภาพรวม</h2>
                    {alerts.length > 0 && <AlertsPanel alerts={alerts} />}
                    
                    <div>
                        <div className="flex justify-between items-center mb-4 flex-wrap gap-2">
                            <h3 className="text-xl font-semibold text-gray-700">ภาพรวมกระบวนการในสัปดาห์นี้</h3>
                            <div>
                                <label className="mr-2 text-sm">ตำแหน่งงาน:</label>
                                <select 
                                    value={selectedJobIdForFunnel} 
                                    onChange={(e) => setSelectedJobIdForFunnel(e.target.value)} 
                                    className="p-2 border rounded-md bg-white text-sm shadow-sm"
                                >
                                    <option value="all">ทุกตำแหน่ง</option>
                                    {openJobs.map(job => (
                                        <option key={job.id} value={job.id}>{job.job_title}</option>
                                    ))}
                                </select>
                            </div>
                        </div>
                        <WeeklyFunnel data={weeklyData} />
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-5 gap-8">
                        <div className="lg:col-span-3 bg-white p-6 rounded-lg shadow-md">
                            <h3 className="text-xl font-semibold mb-4 text-gray-700">แนวโน้มผู้สมัคร (5 สัปดาห์ล่าสุด)</h3>
                            <SimpleBarChart data={applicantTrendData} />
                        </div>
                        <div className="lg:col-span-2 space-y-4">
                               <KpiCard title="ตำแหน่งที่เปิดอยู่" value={kpi.openJobs} icon={<Target size={32}/>} color="text-blue-500" />
                               <KpiCard title="Success Rate (%)" value={kpi.successRate} icon={<CheckCircle size={32}/>} color="text-green-500" />
                               <KpiCard title="เวลาเฉลี่ยปิดจ๊อบ (วันทำการ)" value={kpi.avgTimeToFill} icon={<Clock size={32}/>} color="text-purple-500" />
                        </div>
                    </div>
                </div>
            );
        };

        const SimpleBarChart = memo(({ data }) => {
            const maxValue = useMemo(() => {
                const values = data.map(item => item['ผู้สมัครใหม่']);
                return Math.max(...values, 1);
            }, [data]);

            return (
                <div className="w-full h-[300px] bg-white p-4 flex flex-col">
                    <div className="flex-grow flex justify-around items-end gap-2 border-l border-b border-gray-200 pl-2">
                        {data.map((item, index) => (
                            <div key={index} className="flex-1 flex flex-col items-center justify-end group h-full">
                                <div className="text-sm font-bold text-gray-600 opacity-0 group-hover:opacity-100 transition-opacity -mb-1">{item['ผู้สมัครใหม่']}</div>
                                <div 
                                    className="w-3/5 bg-indigo-400 hover:bg-indigo-500 rounded-t-md transition-all duration-300"
                                    style={{ height: `${(item['ผู้สมัครใหม่'] / maxValue) * 100}%` }}
                                    title={`${item.name}: ${item['ผู้สมัครใหม่']} คน`}
                                >
                                </div>
                            </div>
                        ))}
                    </div>
                    <div className="flex justify-around mt-2 border-t border-gray-200 pt-2">
                        {data.map((item, index) => (
                            <div key={index} className="flex-1 text-center text-xs text-gray-500">
                                {item.name}
                            </div>
                        ))}
                    </div>
                </div>
            );
        });

        const WeeklyFunnel = memo(({ data }) => {
            const { newApplicantsThisWeek, testsCompletedThisWeek, interviewedThisWeek, offeredThisWeek } = data;

            const calculateRate = (current, previous) => {
                if (previous === 0) return 0;
                return ((current / previous) * 100).toFixed(0);
            };

            const testRate = calculateRate(testsCompletedThisWeek, newApplicantsThisWeek);
            const interviewRate = calculateRate(interviewedThisWeek, testsCompletedThisWeek);
            const offerRate = calculateRate(offeredThisWeek, interviewedThisWeek);

            const STAGE_VISUALS = {
                sky: { bg: 'bg-sky-100', text: 'text-sky-600' },
                amber: { bg: 'bg-amber-100', text: 'text-amber-600' },
                purple: { bg: 'bg-purple-100', text: 'text-purple-600' },
                blue: { bg: 'bg-blue-100', text: 'text-blue-600' },
            };

            const funnelStages = [
                { title: "ผู้สมัครใหม่", value: newApplicantsThisWeek, icon: FileText, color: "sky", rate: null },
                { title: "ทำแบบทดสอบแล้ว", value: testsCompletedThisWeek, icon: ClipboardCheck, color: "amber", rate: testRate },
                { title: "เข้าสู่รอบสัมภาษณ์", value: interviewedThisWeek, icon: Users, color: "purple", rate: interviewRate },
                { title: "ได้รับข้อเสนอ", value: offeredThisWeek, icon: Award, color: "blue", rate: offerRate },
            ];

            return (
                <div className="bg-white p-6 rounded-lg shadow-md">
                    <div className="flex flex-col md:flex-row justify-between items-stretch">
                        {funnelStages.map((stage, index) => {
                            const visuals = STAGE_VISUALS[stage.color];
                            const StageIcon = stage.icon;
                            const nextStage = funnelStages[index + 1];
                            return (
                                <React.Fragment key={stage.title}>
                                    <div className="flex-1 flex flex-col items-center text-center p-4">
                                        <div className={`${visuals.bg} p-4 rounded-full mb-3`}>
                                            <StageIcon size={32} className={visuals.text} />
                                        </div>
                                        <p className="text-4xl font-bold text-gray-800">{stage.value}</p>
                                        <p className="text-gray-500 font-medium">{stage.title}</p>
                                    </div>
                                    {nextStage && (
                                        <div className="flex items-center justify-center my-4 md:my-0">
                                            <div className="flex flex-col items-center w-24">
                                                 <ArrowRight className="text-gray-300" size={24} />
                                                 {stage.rate !== null && (
                                                     <span className={`mt-2 text-sm font-bold ${STAGE_VISUALS[nextStage.color].text} ${STAGE_VISUALS[nextStage.color].bg} px-2 py-1 rounded-full`}>
                                                         {stage.rate}%
                                                     </span>
                                                 )}
                                            </div>
                                        </div>
                                    )}
                                </React.Fragment>
                            )
                        })}
                    </div>
                </div>
            );
        });

        const KpiCard = memo(({ title, value, icon, color = 'text-gray-600' }) => (
            <div className="bg-white p-4 rounded-lg shadow-md flex items-center">
                <div className={`mr-4 ${color}`}>
                    {icon}
                </div>
                <div>
                    <p className="text-gray-500 text-sm">{title}</p>
                    <p className="text-2xl font-bold text-gray-800">{value}</p>
                </div>
            </div>
        ));

        const AlertsPanel = memo(({ alerts }) => (
            <div className="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6 rounded-r-lg shadow-sm">
                <div className="flex items-center">
                    <AlertTriangle className="text-yellow-500 mr-3" />
                    <h3 className="text-xl font-bold text-yellow-800">แจ้งเตือน (KPI Alerts)</h3>
                </div>
                <div className="mt-2 ml-8 space-y-1">
                    {alerts.map(job => (
                        <div key={job.id} className="text-yellow-700">
                            <span className="font-semibold">{job.job_title} ({job.position_level})</span>: {job.kpiStatus.message}
                        </div>
                    ))}
                </div>
            </div>
        ));

        // --- คอมโพเนนต์รายการตำแหน่งงาน ---
        const getKpiStatus = (job) => {
            if (['Filled', 'Cancelled'].includes(job.status)) return { status: 'N/A', message: '-', color: 'text-gray-500' };
            if (!job.start_date) return { status: 'N/A', message: 'ไม่ได้ตั้งวันที่เริ่ม', color: 'text-gray-500' };
            const kpiWeeks = KPI_WEEKS[job.position_level];
            if (!kpiWeeks) return { status: 'N/A', message: 'ไม่มี KPI', color: 'text-gray-500' };
            
            const totalKpiBusinessDays = kpiWeeks * 5;
            const businessDaysPassed = calculateBusinessDays(job.start_date, new Date().toISOString().split('T')[0]);
            const businessDaysRemaining = totalKpiBusinessDays - businessDaysPassed;
            const alertThreshold = Math.ceil(totalKpiBusinessDays * 0.3);

            if (businessDaysRemaining < 0) return { status: 'Overdue', message: `เกินกำหนด ${Math.abs(businessDaysRemaining)} วัน`, color: 'text-red-600 font-bold' };
            if (businessDaysRemaining <= alertThreshold) return { status: 'Alert', message: `เหลือ ${businessDaysRemaining} วัน`, color: 'text-yellow-600 font-bold' };
            return { status: 'On Track', message: `เหลือ ${businessDaysRemaining} วัน`, color: 'text-green-600' };
        };

        const JobsList = ({ jobs, onSave, onDelete, setAlertInfo }) => {
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingJob, setEditingJob] = useState(null);
            const handleAddNew = () => { setEditingJob(null); setIsModalOpen(true); };
            const handleEdit = (job) => { setEditingJob(job); setIsModalOpen(true); };
            const handleSaveAndClose = useCallback(async (jobData) => { await onSave(jobData); setIsModalOpen(false); }, [onSave]);
            
            return (
                <div className="bg-white p-6 rounded-lg shadow-md">
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-2xl font-bold text-gray-800">จัดการตำแหน่งงาน</h2>
                        <button onClick={handleAddNew} className="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 flex items-center shadow-sm"><Plus size={18} className="mr-2" /> เพิ่มตำแหน่งใหม่</button>
                    </div>
                    <div className="overflow-x-auto">
                        <table className="w-full text-left">
                            <thead>
                                <tr className="bg-gray-50 border-b">
                                    <th className="p-3 font-semibold text-gray-600">ชื่อตำแหน่ง</th>
                                    <th className="p-3 font-semibold text-gray-600">ระดับตำแหน่ง</th>
                                    <th className="p-3 font-semibold text-gray-600">สร้างโดย</th>
                                    <th className="p-3 font-semibold text-gray-600">สถานะ</th>
                                    <th className="p-3 font-semibold text-gray-600">สถานะ KPI</th>
                                    <th className="p-3 font-semibold text-gray-600">การจัดการ</th>
                                </tr>
                            </thead>
                            <tbody>
                                {jobs.map(job => (
                                    <JobRow key={job.id} job={job} onEdit={handleEdit} onDelete={onDelete} />
                                ))}
                            </tbody>
                        </table>
                    </div>
                    {isModalOpen && <JobFormModal job={editingJob} onSave={handleSaveAndClose} onClose={() => setIsModalOpen(false)} setAlertInfo={setAlertInfo} />}
                </div>
            );
        };

        const JobRow = memo(({ job, onEdit, onDelete }) => {
            const statusColors = { Open: 'bg-blue-100 text-blue-800', Screening: 'bg-yellow-100 text-yellow-800', Interview: 'bg-purple-100 text-purple-800', 'Offer Sent': 'bg-indigo-100 text-indigo-800', Filled: 'bg-green-100 text-green-800', Cancelled: 'bg-red-100 text-red-800' };
            const kpiStatus = getKpiStatus(job);
            return (
                <tr className="border-b hover:bg-gray-50">
                    <td className="p-3 font-medium text-gray-800">{job.job_title}</td>
                    <td className="p-3 text-gray-600">{job.position_level}</td>
                    <td className="p-3 text-sm text-gray-500 truncate" title={job.created_by}>{job.created_by}</td>
                    <td className="p-3"><span className={`px-2 py-1 text-xs font-semibold rounded-full ${statusColors[job.status] || 'bg-gray-100'}`}>{job.status}</span></td>
                    <td className={`p-3 ${kpiStatus.color}`}>{kpiStatus.message}</td>
                    <td className="p-3">
                        <button onClick={() => onEdit(job)} className="text-blue-600 hover:text-blue-800 mr-4 font-medium">แก้ไข</button>
                        <button onClick={() => onDelete(job.id)} className="text-red-600 hover:text-red-800 font-medium">ลบ</button>
                    </td>
                </tr>
            );
        });

        // --- คอมโพเนนต์ฟอร์มตำแหน่งงาน ---
        const JobFormModal = ({ job, onSave, onClose, setAlertInfo }) => {
            const [formData, setFormData] = useState({ id: job?.id || null, job_title: job?.job_title || '', department: job?.department || '', position_level: job?.position_level || 'Officer', type: job?.type || 'Permanent', start_date: job?.start_date || new Date().toISOString().split('T')[0], close_date: job?.close_date || '', status: job?.status || 'Open', description: job?.description || '' });
            const [isGenerating, setIsGenerating] = useState(false);

            const handleChange = (e) => { const { name, value } = e.target; setFormData(prev => ({ ...prev, [name]: value })); };
            const handleSubmit = (e) => { e.preventDefault(); onSave(formData); };
            
            const handleGenerateDescription = async () => {
                if (!formData.job_title || !formData.department) {
                    setAlertInfo({ title: "ข้อมูลไม่ครบถ้วน", message: "กรุณากรอก 'ชื่อตำแหน่ง' และ 'แผนก' ก่อนสร้างคำบรรยายลักษณะงาน" });
                    return;
                }
                setIsGenerating(true);
                const prompt = `เขียนคำบรรยายลักษณะงาน (Job Description) สำหรับตำแหน่ง ${formData.job_title} ในแผนก ${formData.department} ให้หน่อย โดยให้มีเนื้อหาครอบคลุมถึง: หน้าที่ความรับผิดชอบ (Responsibilities), คุณสมบัติ (Qualifications), และทักษะที่จำเป็น (Required Skills) เขียนเป็นภาษาไทยในรูปแบบ Markdown ที่สวยงาม`;
                try {
                    const apiKey = ""; // API Key is handled by the environment
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) {
                        throw new Error(`API call failed with status: ${response.status}`);
                    }
                    const result = await response.json();
                    if (result.candidates && result.candidates[0]?.content?.parts[0]?.text) {
                        setFormData(prev => ({ ...prev, description: result.candidates[0].content.parts[0].text }));
                    } else {
                        throw new Error("Invalid response structure from Gemini API");
                    }
                } catch (error) {
                    console.error("Error generating job description:", error);
                    setAlertInfo({ title: "เกิดข้อผิดพลาด", message: "ไม่สามารถสร้างคำบรรยายลักษณะงานได้ในขณะนี้" });
                } finally {
                    setIsGenerating(false);
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
                    <div className="bg-white p-8 rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
                        <h2 className="text-2xl font-bold mb-6">{job ? 'แก้ไขตำแหน่งงาน' : 'สร้างตำแหน่งงานใหม่'}</h2>
                        <form onSubmit={handleSubmit} className="flex-grow overflow-y-auto pr-2">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div><label className="block text-sm font-medium text-gray-700 mb-1">ชื่อตำแหน่ง</label><input type="text" name="job_title" value={formData.job_title} onChange={handleChange} className="w-full p-2 border rounded-md" required /></div>
                                <div><label className="block text-sm font-medium text-gray-700 mb-1">แผนก</label><input type="text" name="department" value={formData.department} onChange={handleChange} className="w-full p-2 border rounded-md" required /></div>
                                <div><label className="block text-sm font-medium text-gray-700 mb-1">ระดับตำแหน่ง</label><select name="position_level" value={formData.position_level} onChange={handleChange} className="w-full p-2 border rounded-md bg-white">{POSITION_LEVELS.map(level => <option key={level} value={level}>{level}</option>)}</select></div>
                                <div><label className="block text-sm font-medium text-gray-700 mb-1">ประเภทตำแหน่ง</label><select name="type" value={formData.type} onChange={handleChange} className="w-full p-2 border rounded-md bg-white"><option>Permanent</option><option>Internship</option><option>Temporary</option></select></div>
                                <div><label className="block text-sm font-medium text-gray-700 mb-1">สถานะ</label><select name="status" value={formData.status} onChange={handleChange} className="w-full p-2 border rounded-md bg-white"><option>Open</option><option>Screening</option><option>Interview</option><option>Offer Sent</option><option>Filled</option><option>Cancelled</option></select></div>
                                <div><label className="block text-sm font-medium text-gray-700 mb-1">วันที่เริ่มเปิดรับ</label><input type="date" name="start_date" value={formData.start_date} onChange={handleChange} className="w-full p-2 border rounded-md" required /></div>
                                <div className="md:col-span-2"><div className="flex justify-between items-center mb-1"><label className="block text-sm font-medium text-gray-700">คำบรรยายลักษณะงาน (JD)</label><button type="button" onClick={handleGenerateDescription} disabled={isGenerating} className="flex items-center text-sm text-blue-600 hover:text-blue-800 disabled:text-gray-400 disabled:cursor-wait"><Sparkles size={16} className="mr-1" />{isGenerating ? 'กำลังสร้าง...' : '✨ สร้างด้วย AI'}</button></div><textarea name="description" value={formData.description} onChange={handleChange} rows="8" className="w-full p-2 border rounded-md"></textarea></div>
                                <div><label className="block text-sm font-medium text-gray-700 mb-1">วันที่ปิด (ถ้ามี)</label><input type="date" name="close_date" value={formData.close_date} onChange={handleChange} className="w-full p-2 border rounded-md" /></div>
                            </div>
                        </form>
                        <div className="mt-8 flex justify-end gap-4 border-t pt-6">
                            <button type="button" onClick={onClose} className="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300">ยกเลิก</button>
                            <button type="button" onClick={handleSubmit} className="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">บันทึก</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- คอมโพเนนต์กระดานคัมบัง ---
        const STAGE_STYLES = {
            Applied: { icon: FileText, color: 'border-t-sky-500', titleColor: 'text-sky-700' },
            'ทำแบบทดสอบแล้ว': { icon: ClipboardCheck, color: 'border-t-amber-500', titleColor: 'text-amber-700' },
            Interviewed: { icon: Users, color: 'border-t-purple-500', titleColor: 'text-purple-700' },
            Offered: { icon: Award, color: 'border-t-blue-500', titleColor: 'text-blue-700' },
            Hired: { icon: PartyPopper, color: 'border-t-green-500', titleColor: 'text-green-700' },
            Rejected: { icon: XCircle, color: 'border-t-red-500', titleColor: 'text-red-700' },
        };

        const KanbanBoard = ({ jobs, candidates, onUpdateCandidateStage, onSaveCandidate, onUpdateCandidate, onDeleteCandidate, onMarkTestCompleted, setAlertInfo }) => {
            const [isCandidateModalOpen, setIsCandidateModalOpen] = useState(false);
            const [isQuestionModalOpen, setIsQuestionModalOpen] = useState(false);
            const [selectedJobId, setSelectedJobId] = useState('all');
            const [editingCandidate, setEditingCandidate] = useState(null);
            
            const openJobs = useMemo(() => jobs.filter(j => !['Filled', 'Cancelled'].includes(j.status)), [jobs]);
            
            useEffect(() => { 
                if (openJobs.length > 0 && selectedJobId === 'all') { 
                    setSelectedJobId(openJobs[0].id); 
                } 
            }, [jobs, openJobs]);

            const stages = ['Applied', 'ทำแบบทดสอบแล้ว', 'Interviewed', 'Offered', 'Hired', 'Rejected'];
            const filteredCandidates = useMemo(() => { 
                if (selectedJobId === 'all') return candidates;
                return candidates.filter(c => c.job_id === selectedJobId); 
            }, [candidates, selectedJobId]);

            const handleDragStart = (e, candidateId) => e.dataTransfer.setData("candidateId", candidateId);
            const handleDragOver = (e) => e.preventDefault();
            const handleDrop = (e, newStage) => { const candidateId = e.dataTransfer.getData("candidateId"); if(candidateId) onUpdateCandidateStage(candidateId, newStage); };
            const getJobTitle = useCallback((jobId) => jobs.find(j => j.id === jobId)?.job_title || 'N/A', [jobs]);
            
            const handleOpenAddModal = () => {
                setEditingCandidate(null);
                setIsCandidateModalOpen(true);
            };

            const handleOpenEditModal = (candidate) => {
                setEditingCandidate(candidate);
                setIsCandidateModalOpen(true);
            };

            const handleSaveAndClose = useCallback(async (candidateData, photoFile) => { 
                try {
                    if (editingCandidate) {
                        await onUpdateCandidate(candidateData, photoFile);
                    } else {
                        await onSaveCandidate(candidateData, photoFile); 
                    }
                    setIsCandidateModalOpen(false); 
                } catch (error) {
                    console.error("Failed to save candidate:", error);
                    setAlertInfo({ title: "เกิดข้อผิดพลาด", message: error.message });
                }
            }, [onSaveCandidate, onUpdateCandidate, editingCandidate, setAlertInfo]);

            return (
                <div>
                    <div className="flex justify-between items-center mb-6 flex-wrap gap-4">
                        <h2 className="text-3xl font-bold text-gray-800">กระดานคัมบัง</h2>
                        <div className="flex items-center gap-4 flex-wrap">
                            <button onClick={() => setIsQuestionModalOpen(true)} className="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600 flex items-center shadow-sm"><Sparkles size={18} className="mr-2" /> สร้างคำถามสัมภาษณ์</button>
                            <button onClick={handleOpenAddModal} className="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 flex items-center shadow-sm"><UserPlus size={18} className="mr-2" /> เพิ่มผู้สมัคร</button>
                            <div>
                                <label className="mr-2">ตำแหน่งงาน:</label>
                                <select value={selectedJobId} onChange={(e) => setSelectedJobId(e.target.value)} className="p-2 border rounded-md bg-white shadow-sm">
                                    <option value="all">ทุกตำแหน่ง</option>
                                    {openJobs.map(job => (<option key={job.id} value={job.id}>{job.job_title}</option>))}
                                </select>
                            </div>
                        </div>
                    </div>
                    <div className="flex gap-6 overflow-x-auto pb-4">
                        {stages.map(stage => {
                            const stageInfo = STAGE_STYLES[stage] || {};
                            const StageIcon = stageInfo.icon || 'div';
                            const candidatesInStage = filteredCandidates.filter(c => c.stage === stage);
                            return (
                                <div key={stage} className={`bg-slate-100 rounded-lg w-80 md:w-88 flex-shrink-0 border-t-4 ${stageInfo.color}`} onDragOver={handleDragOver} onDrop={(e) => handleDrop(e, stage)}>
                                    <div className="p-4">
                                        <div className={`flex items-center justify-between mb-4 ${stageInfo.titleColor}`}>
                                            <div className="flex items-center gap-2">
                                                <StageIcon size={20} />
                                                <h3 className="font-bold text-lg">{stage}</h3>
                                            </div>
                                            <span className="bg-gray-200 text-gray-700 text-sm font-bold px-2.5 py-1 rounded-full">{candidatesInStage.length}</span>
                                        </div>
                                        <div className="space-y-4 min-h-[200px]">
                                            {candidatesInStage.map(candidate => (
                                                <CandidateCard 
                                                    key={candidate.id} 
                                                    candidate={candidate} 
                                                    onDragStart={handleDragStart} 
                                                    getJobTitle={getJobTitle} 
                                                    selectedJobId={selectedJobId} 
                                                    onMarkTestCompleted={onMarkTestCompleted} 
                                                    onEdit={handleOpenEditModal}
                                                    onDelete={onDeleteCandidate}
                                                />
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            )
                        })}
                    </div>
                    {isCandidateModalOpen && <CandidateFormModal candidate={editingCandidate} jobs={openJobs} onSave={handleSaveAndClose} onClose={() => setIsCandidateModalOpen(false)} setAlertInfo={setAlertInfo} />}
                    {isQuestionModalOpen && <InterviewQuestionModal jobs={openJobs} onClose={() => setIsQuestionModalOpen(false)} setAlertInfo={setAlertInfo} />}
                </div>
            );
        };

        const CandidateCard = memo(({ candidate, onDragStart, getJobTitle, selectedJobId, onMarkTestCompleted, onEdit, onDelete }) => {
            return (
                <div draggable onDragStart={(e) => onDragStart(e, candidate.id)} className="bg-white rounded-lg shadow-sm cursor-grab border border-gray-200 hover:shadow-md transition-shadow overflow-hidden">
                    <img src={candidate.photo_url} alt={candidate.name} className="w-full h-32 object-cover bg-gray-200" onError={(e) => { e.target.onerror = null; e.target.src='https://placehold.co/352x128/EFEFEF/AAAAAA?text=Photo'; }} />
                    <div className="p-3">
                        <div className="flex justify-between items-start">
                            <p className="font-semibold text-gray-800">{candidate.name}</p>
                            <div className="flex items-center">
                                <button onClick={() => onEdit(candidate)} title="แก้ไขข้อมูล" className="p-1 rounded-full text-gray-400 hover:bg-gray-200 hover:text-gray-600">
                                    <Edit size={16} />
                                </button>
                                <button onClick={() => onDelete(candidate.id)} title="ลบข้อมูล" className="p-1 rounded-full text-gray-400 hover:bg-red-200 hover:text-red-600 ml-1">
                                    <Trash size={16} />
                                </button>
                            </div>
                        </div>
                        <p className="text-xs text-gray-500 truncate">{candidate.email || 'ไม่มีอีเมล'}</p>
                        {selectedJobId === 'all' && <p className="text-xs text-gray-500 mt-1 font-medium">{getJobTitle(candidate.job_id)}</p>}
                        <p className="text-sm text-gray-600 my-3">{candidate.note}</p>
                        <div className="text-xs grid grid-cols-4 gap-2 text-center bg-slate-50 p-2 rounded-md">
                            <div><div className="text-gray-500">Li1</div><div className="font-bold text-gray-800">{candidate.li1_score || '-'}</div></div>
                            <div><div className="text-gray-500">Li2</div><div className="font-bold text-gray-800">{candidate.li2_score || '-'}</div></div>
                            <div><div className="text-gray-500">Li3</div><div className="font-bold text-gray-800">{candidate.li3_score || '-'}</div></div>
                            <div><div className="text-gray-500">Eng</div><div className="font-bold text-gray-800">{candidate.eng_score || '-'}</div></div>
                        </div>
                        <div className="mt-3 flex justify-between items-center">
                                {candidate.test_completed_on ? 
                                <p className="text-xs text-green-600 flex items-center"><CheckCircle size={14} className="mr-1"/>ทดสอบแล้ว: {candidate.test_completed_on}</p> 
                                : <div/>}
                            <button onClick={() => onMarkTestCompleted(candidate.id)} title="บันทึกว่าทำแบบทดสอบแล้ว" className={`p-1.5 rounded-full ${candidate.test_completed_on ? 'text-green-500 cursor-not-allowed' : 'text-gray-400 hover:bg-gray-200 hover:text-gray-600'}`} disabled={!!candidate.test_completed_on}><ClipboardCheck size={18} /></button>
                        </div>
                    </div>
                </div>
            );
        });

        // --- คอมโพเนนต์ฟอร์มผู้สมัคร ---
        const CandidateFormModal = ({ candidate, jobs, onSave, onClose, setAlertInfo }) => {
            const [formData, setFormData] = useState({
                id: candidate?.id || null,
                name: candidate?.name || '',
                email: candidate?.email || '',
                job_id: candidate?.job_id || jobs[0]?.id || '',
                note: candidate?.note || '',
                li1_score: candidate?.li1_score || '',
                li2_score: candidate?.li2_score || '',
                li3_score: candidate?.li3_score || '',
                eng_score: candidate?.eng_score || ''
            });
            const [photoFile, setPhotoFile] = useState(null);
            const [photoPreview, setPhotoPreview] = useState(candidate?.photo_url || '');
            const [isUploading, setIsUploading] = useState(false);
            const [sheetCandidates, setSheetCandidates] = useState([]);
            const [isSheetLoading, setIsSheetLoading] = useState(true);

            const GOOGLE_API_KEY = "AIzaSyC-y-JKFQcIAiZey8ZSgomCBTqUZo-MguU"; // ใส่ Google API Key ของคุณที่นี่

            useEffect(() => {
                const fetchSheetDataForModal = async () => {
                    if (!GOOGLE_API_KEY) {
                        console.warn("Google API Key not provided for candidate autofill.");
                        setIsSheetLoading(false);
                        return;
                    }
                    const SPREADSHEET_ID = '1GniK2l2SNswJF4AB2_Lxvb1If1fPnehrKzEP7GqQs34';
                    const RANGE = 'Sheet1!A2:C'; // ดึงข้อมูลจากคอลัมน์ A ถึง C
                    const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${RANGE}?key=${GOOGLE_API_KEY}`;
                    
                    try {
                        const response = await fetch(url);
                        if (!response.ok) throw new Error("Failed to fetch from Google Sheet");
                        const data = await response.json();
                        const parsedData = data.values?.map(row => ({ name: row[1], email: row[2] })) || [];
                        setSheetCandidates(parsedData);
                    } catch (error) {
                        console.error("Error fetching sheet data for modal:", error);
                        setAlertInfo({ title: "เกิดข้อผิดพลาด", message: "ไม่สามารถดึงรายชื่อผู้สมัครจาก Google Sheet ได้" });
                    } finally {
                        setIsSheetLoading(false);
                    }
                };
                fetchSheetDataForModal();
            }, [setAlertInfo]);

            const handleSheetCandidateChange = (e) => {
                const selectedIndex = e.target.value;
                if (selectedIndex) {
                    const selectedCandidate = sheetCandidates[selectedIndex];
                    setFormData(prev => ({
                        ...prev,
                        name: selectedCandidate.name || '',
                        email: selectedCandidate.email || ''
                    }));
                } else {
                     setFormData(prev => ({
                        ...prev,
                        name: '',
                        email: ''
                    }));
                }
            };

            const handleDataChange = (e) => { const { name, value, type } = e.target; setFormData(prev => ({ ...prev, [name]: type === 'number' ? (value ? parseInt(value, 10) : '') : value })); };
            
            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    setPhotoFile(file);
                    setPhotoPreview(URL.createObjectURL(file));
                }
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!formData.job_id) { 
                    setAlertInfo({title: "ข้อมูลไม่ครบถ้วน", message: "กรุณาเลือกตำแหน่งงาน"});
                    return; 
                }
                setIsUploading(true);
                try {
                    await onSave(formData, photoFile);
                } finally {
                    setIsUploading(false);
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
                    <div className="bg-white p-8 rounded-lg shadow-xl w-full max-w-2xl">
                        <h2 className="text-2xl font-bold mb-6">{candidate ? 'แก้ไขข้อมูลผู้สมัคร' : 'เพิ่มผู้สมัครใหม่'}</h2>
                        <form onSubmit={handleSubmit}>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                                {!candidate && (
                                    <div className="md:col-span-2">
                                        <label className="block text-sm font-medium text-gray-700 mb-1">เลือกผู้สมัครจากชีท (ถ้ามี)</label>
                                        <select 
                                            onChange={handleSheetCandidateChange}
                                            className="w-full p-2 border rounded-md bg-white"
                                            disabled={isSheetLoading}
                                        >
                                            <option value="">-- {isSheetLoading ? 'กำลังโหลด...' : 'เลือกเพื่อกรอกข้อมูลอัตโนมัติ'} --</option>
                                            {sheetCandidates.map((c, index) => (
                                                <option key={index} value={index}>
                                                    {c.name} ({c.email})
                                                </option>
                                            ))}
                                        </select>
                                    </div>
                                )}
                                <div className="md:col-span-2"><label className="block text-sm font-medium text-gray-700 mb-1">ชื่อผู้สมัคร</label><input type="text" name="name" value={formData.name} onChange={handleDataChange} className="w-full p-2 border rounded-md" required /></div>
                                <div className="md:col-span-2"><label className="block text-sm font-medium text-gray-700 mb-1">อีเมลผู้สมัคร</label><input type="email" name="email" value={formData.email} onChange={handleDataChange} className="w-full p-2 border rounded-md" /></div>
                                <div className="md:col-span-2"><label className="block text-sm font-medium text-gray-700 mb-1">ตำแหน่งงานที่สมัคร</label><select name="job_id" value={formData.job_id} onChange={handleDataChange} className="w-full p-2 border rounded-md bg-white" required>{jobs.length > 0 ? jobs.map(job => (<option key={job.id} value={job.id}>{job.job_title}</option>)) : (<option value="" disabled>ไม่มีตำแหน่งงานที่เปิดอยู่</option>)}</select></div>
                                <div className="md:col-span-2"><label className="block text-sm font-medium text-gray-700 mb-1">แนบรูปภาพ</label><div className="flex items-center gap-4"><input type="file" name="photo_file" onChange={handleFileChange} className="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" accept="image/*" />{photoPreview && <img src={photoPreview} alt="Preview" className="w-16 h-16 rounded-full object-cover"/>}</div></div>
                                <div><label className="block text-sm font-medium text-gray-700 mb-1">คะแนน Li1</label><input type="number" name="li1_score" value={formData.li1_score} onChange={handleDataChange} className="w-full p-2 border rounded-md" /></div>
                                <div><label className="block text-sm font-medium text-gray-700 mb-1">คะแนน Li2</label><input type="number" name="li2_score" value={formData.li2_score} onChange={handleDataChange} className="w-full p-2 border rounded-md" /></div>
                                <div><label className="block text-sm font-medium text-gray-700 mb-1">คะแนน Li3</label><input type="number" name="li3_score" value={formData.li3_score} onChange={handleDataChange} className="w-full p-2 border rounded-md" /></div>
                                <div><label className="block text-sm font-medium text-gray-700 mb-1">คะแนน Eng</label><input type="number" name="eng_score" value={formData.eng_score} onChange={handleDataChange} className="w-full p-2 border rounded-md" /></div>
                                <div className="md:col-span-2"><label className="block text-sm font-medium text-gray-700 mb-1">บันทึกเพิ่มเติม (Note)</label><textarea name="note" value={formData.note} onChange={handleDataChange} rows="3" className="w-full p-2 border rounded-md"></textarea></div>
                            </div>
                            <div className="mt-8 flex justify-end gap-4">
                                <button type="button" onClick={onClose} className="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300" disabled={isUploading}>ยกเลิก</button>
                                <button type="submit" className="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 flex items-center justify-center w-24" disabled={isUploading}>{isUploading ? <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div> : 'บันทึก'}</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        // --- คอมโพเนนต์สร้างคำถามสัมภาษณ์ ---
        const InterviewQuestionModal = ({ jobs, onClose, setAlertInfo }) => {
            const [selectedJobId, setSelectedJobId] = useState(jobs[0]?.id || '');
            const [questions, setQuestions] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState('');

            const handleGenerate = async () => {
                const job = jobs.find(j => j.id === selectedJobId);
                if (!job) {
                    setError('กรุณาเลือกตำแหน่งงาน');
                    return;
                }
                setIsLoading(true);
                setError('');
                setQuestions('');

                const prompt = `ช่วยสร้างชุดคำถามสัมภาษณ์สำหรับตำแหน่ง ${job.job_title} ระดับ ${job.position_level} หน่อย โดยแบ่งเป็น 2 ส่วน: 1. คำถามเชิงพฤติกรรม (Behavioral Questions) 5 ข้อ และ 2. คำถามเชิงเทคนิค (Technical Questions) 5 ข้อ เขียนเป็นภาษาไทยในรูปแบบ Markdown ที่ชัดเจนและสวยงาม`;
                
                try {
                    const apiKey = ""; // API Key is handled by the environment
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`API Error: ${response.status}`);
                    const result = await response.json();
                    if (result.candidates && result.candidates[0]?.content?.parts[0]?.text) {
                        setQuestions(result.candidates[0].content.parts[0].text);
                    } else {
                        throw new Error("Invalid response structure from Gemini API");
                    }
                } catch (err) {
                    console.error("Error generating questions:", err);
                    setError("เกิดข้อผิดพลาดในการสร้างคำถาม");
                } finally {
                    setIsLoading(false);
                }
            };
            
            const handleCopy = () => {
                if (!navigator.clipboard) {
                    const textArea = document.createElement('textarea');
                    textArea.value = questions;
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        setAlertInfo({title: "สำเร็จ", message: "คัดลอกคำถามแล้ว!"});
                    } catch (err) {
                        setAlertInfo({title: "ข้อผิดพลาด", message: "ไม่สามารถคัดลอกได้"});
                    }
                    document.body.removeChild(textArea);
                    return;
                }
                navigator.clipboard.writeText(questions).then(() => {
                    setAlertInfo({title: "สำเร็จ", message: "คัดลอกคำถามแล้ว!"});
                }, (err) => {
                    console.error('Async: Could not copy text: ', err);
                    setAlertInfo({title: "ข้อผิดพลาด", message: "ไม่สามารถคัดลอกได้"});
                });
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
                    <div className="bg-white p-8 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
                        <h2 className="text-2xl font-bold mb-4 flex items-center"><Sparkles size={24} className="mr-2 text-purple-500"/> สร้างคำถามสัมภาษณ์</h2>
                        <div className="flex items-end gap-4 mb-4">
                            <div className="flex-grow">
                                <label className="block text-sm font-medium text-gray-700 mb-1">เลือกตำแหน่งงาน</label>
                                <select value={selectedJobId} onChange={(e) => setSelectedJobId(e.target.value)} className="w-full p-2 border rounded-md bg-white">
                                    {jobs.map(job => <option key={job.id} value={job.id}>{job.job_title}</option>)}
                                </select>
                            </div>
                            <button onClick={handleGenerate} disabled={isLoading || !selectedJobId} className="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600 disabled:bg-gray-400 flex items-center w-36 justify-center">
                                {isLoading ? <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div> : 'สร้างคำถาม'}
                            </button>
                        </div>
                        <div className="flex-grow bg-gray-50 p-4 rounded-md overflow-y-auto border relative">
                            {isLoading && <div className="absolute inset-0 flex items-center justify-center bg-white bg-opacity-75"><p>กำลังสร้างคำถาม...</p></div>}
                            {error && <p className="text-red-500">{error}</p>}
                            {questions && (
                                <div>
                                    <button onClick={handleCopy} className="absolute top-2 right-2 bg-gray-200 hover:bg-gray-300 p-2 rounded-full" title="คัดลอก"><Copy size={16}/></button>
                                    <pre className="whitespace-pre-wrap font-sans text-sm">{questions}</pre>
                                </div>
                            )}
                        </div>
                        <div className="mt-6 flex justify-end">
                            <button type="button" onClick={onClose} className="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300">ปิด</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- คอมโพเนนต์ประวัติ ---
        const History = ({ jobs }) => {
            const closedJobs = useMemo(() => {
                return jobs
                    .filter(job => ['Filled', 'Cancelled'].includes(job.status) && job.start_date && job.close_date)
                    .map(job => {
                        const timeToFill = calculateBusinessDays(job.start_date, job.close_date);
                        const kpiWeeks = KPI_WEEKS[job.position_level];
                        const kpiDays = kpiWeeks ? kpiWeeks * 5 : null;
                        let kpiMet = 'N/A';
                        if (kpiDays !== null && job.status === 'Filled') { kpiMet = timeToFill <= kpiDays ? 'ผ่าน' : 'ไม่ผ่าน'; }
                        return { ...job, timeToFill, kpiMet };
                    })
                    .sort((a, b) => new Date(b.close_date) - new Date(a.close_date));
            }, [jobs]);

            return (
                <div className="bg-white p-6 rounded-lg shadow-md">
                    <h2 className="text-2xl font-bold text-gray-800 mb-4">ประวัติการปิดตำแหน่งงาน</h2>
                    <div className="overflow-x-auto">
                        <table className="w-full text-left">
                            <thead>
                                <tr className="bg-gray-50 border-b">
                                    <th className="p-3 font-semibold text-gray-600">ชื่อตำแหน่ง</th>
                                    <th className="p-3 font-semibold text-gray-600">ระดับตำแหน่ง</th>
                                    <th className="p-3 font-semibold text-gray-600">วันที่ปิด</th>
                                    <th className="p-3 font-semibold text-gray-600">สถานะ</th>
                                    <th className="p-3 font-semibold text-gray-600 text-center">ระยะเวลา (วันทำการ)</th>
                                    <th className="p-3 font-semibold text-gray-600 text-center">ผลลัพธ์ KPI</th>
                                </tr>
                            </thead>
                            <tbody>
                                {closedJobs.map(job => (
                                    <tr key={job.id} className="border-b hover:bg-gray-50">
                                        <td className="p-3 font-medium text-gray-800">{job.job_title}</td>
                                        <td className="p-3 text-gray-600">{job.position_level}</td>
                                        <td className="p-3 text-gray-600">{job.close_date}</td>
                                        <td className="p-3"><span className={`px-2 py-1 text-xs font-semibold rounded-full ${job.status === 'Filled' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>{job.status}</span></td>
                                        <td className="p-3 text-center text-gray-600">{job.timeToFill}</td>
                                        <td className={`p-3 font-bold text-center ${job.kpiMet === 'ผ่าน' ? 'text-green-600' : job.kpiMet === 'ไม่ผ่าน' ? 'text-red-600' : 'text-gray-500'}`}>{job.kpiMet}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };
        
        // --- คอมโพเนนต์แสดงข้อมูลจาก Google Sheet ---
        const GoogleSheetView = ({ setAlertInfo }) => {
            const [sheetData, setSheetData] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            
            const GOOGLE_API_KEY = "AIzaSyC-y-JKFQcIAiZey8ZSgomCBTqUZo-MguU"; // ใส่ Google API Key ของคุณที่นี่
            const SPREADSHEET_ID = '1GniK2l2SNswJF4AB2_Lxvb1If1fPnehrKzEP7GqQs34';
            const RANGE = 'Sheet1';

            useEffect(() => {
                const fetchSheetData = async () => {
                    if (!GOOGLE_API_KEY) {
                        setAlertInfo({ title: "การตั้งค่าไม่สมบูรณ์", message: "ไม่ได้กำหนด Google API Key ในโค้ด" });
                        setIsLoading(false);
                        return;
                    }

                    const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${RANGE}?key=${GOOGLE_API_KEY}`;
                    
                    try {
                        const response = await fetch(url);
                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.error.message || 'ไม่สามารถดึงข้อมูลได้');
                        }
                        const data = await response.json();
                        setSheetData(data.values || []);
                    } catch (error) {
                        console.error("Error fetching Google Sheet data:", error);
                        setAlertInfo({ title: "เกิดข้อผิดพลาด", message: `ไม่สามารถดึงข้อมูลจาก Google Sheet ได้: ${error.message}` });
                    } finally {
                        setIsLoading(false);
                    }
                };

                fetchSheetData();
            }, [setAlertInfo]);

            return (
                 <div className="bg-white p-6 rounded-lg shadow-md">
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-2xl font-bold text-gray-800">รายชื่อผู้สมัครทำแบบทดสอบ (จาก Google Sheet)</h2>
                        <a 
                            href={`https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/edit`} 
                            target="_blank" 
                            rel="noopener noreferrer"
                            className="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 flex items-center shadow-sm"
                        >
                            <Sheet size={18} className="mr-2" /> เปิด Google Sheet
                        </a>
                    </div>
                    {isLoading ? (
                        <div className="flex justify-center items-center h-64">
                            <div className="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-blue-500"></div>
                        </div>
                    ) : (
                        <div className="overflow-x-auto">
                            <table className="w-full text-left">
                                <thead>
                                    <tr className="bg-gray-50 border-b">
                                        {sheetData[0]?.map((header, index) => (
                                            <th key={index} className="p-3 font-semibold text-gray-600">{header}</th>
                                        ))}
                                    </tr>
                                </thead>
                                <tbody>
                                    {sheetData.slice(1).map((row, rowIndex) => (
                                        <tr key={rowIndex} className="border-b hover:bg-gray-50">
                                            {row.map((cell, cellIndex) => (
                                                <td key={cellIndex} className="p-3 text-gray-600">{cell}</td>
                                            ))}
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                </div>
            );
        };


        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);

    </script>
</body>
</html>
